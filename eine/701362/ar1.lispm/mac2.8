;; Macros, version 2.		DLW 11/27/77 -*-LISP-*-

(DECLARE (SPECIAL MACRO-IO-UNTYI MACRO-STATE MACRO-INPUT-STREAM MACRO-ARRAY
		  MACRO-TIMES MACRO-COUNT MACRO-ESCAPE-CHAR MACRO-POINTER))

(SETQ MACRO-IO-UNTYI NIL MACRO-IO-ESCAPE-CHAR ## )

(DEFUN MACRO-IO-TYI (STREAM &AUX CHAR)
    (SETQ CHAR (FUNCALL STREAM 'TYI))
    (COND ((NULL CHAR) NIL)
	  ((NOT (= CHAR MACRO-ESCAPE-CHAR)) CHAR)
	  ((NULL (SETQ CHAR (FUNCALL STREAM 'TYI))) NIL)
	  ((= CHAR ## E) '(ENTER))
	  ((= CHAR ## R) (LIST 'REPEAT (- (FUNCALL STREAM 'TYI) 60)))	;Kludge...
	  (T '(ERROR))))

(DEFUN MAKE-MACRO-STREAM (&OPTIONAL (INPUT-STREAM 'ED-KEYBOARD-IO))
    (LET ((MACRO-INPUT-STREAM INPUT-STREAM)
	  (MACRO-STATE 'INPUT)
	  (MACRO-INPUT-STREAM INPUT-STREAM)
	  (MACRO-ARRAY (MAKE-ARRAY NIL ART-Q 200 NIL '(0)))
	  (MACRO-TIMES 0)
	  (MACRO-COUNT 0)
	  (MACRO-POINTER 0))
	 (CLOSURE '(MACRO-IO-UNTYI MACRO-STATE MACRO-INPUT-STREAM MACRO-ARRAY MACRO-TIMES
				   MACRO-COUNT MACRO-POINTER)
		  (FUNCTION MACRO-IO))))

(DEFUN MACRO-IO (OP &OPTIONAL ARG1 &AUX CHAR)
    (SELECTQ OP
      (UNTYI
       (SETQ MACRO-IO-UNTYI ARG1))
      (TYI
       (COND (MACRO-IO-UNTYI
	      (PROG1 MACRO-IO-UNTYI (SETQ MACRO-IO-UNTYI NIL)))
	     (T
	      (PROG ()
		    (SELECTQ MACRO-STATE
			     (INPUT (GO INPUT-STATE))
			     (RECORDING (GO RECORDING-STATE))
			     (PLAYBACK (GO PLAYBACK-STATE)))

	         INPUT-STATE
		    (SETQ CHAR (MACRO-IO-TYI MACRO-INPUT-STREAM))
		    (COND ((OR (NUMBERP CHAR) (NULL CHAR))
			   (RETURN CHAR))
			  (T (SELECTQ (CAR CHAR)
			       (ENTER
				(STORE-ARRAY-LEADER 0 MACRO-ARRAY 0)
				(SETQ MACRO-STATE 'RECORDING)
				(GO RECORDING-STATE))
			       (REPEAT
				(ERROR "You are not recording now."))
			       (OTHERWISE (ERROR "Invalid return from MACRO-IO-TYI" CHAR)))))
		 RECORDING-STATE
		    (SETQ CHAR (MACRO-IO-TYI MACRO-INPUT-STREAM))
		    (COND ((NULL CHAR)
			   (RETURN NIL))
			  ((NUMBERP CHAR)
			   (ARRAY-PUSH MACRO-ARRAY CHAR)
			   (RETURN CHAR))
			  (T (SELECTQ (CAR CHAR)
			       (ENTER
				(ERROR "Recursive macros not yet in." NIL))
			       (REPEAT
				(SETQ MACRO-TIMES (CADR CHAR)
				      MACRO-COUNT 0
				      MACRO-STATE 'PLAYBACK
				      MACRO-POINTER 0)
				(COND ((OR (<= MACRO-TIMES 0)
					   (<= (ARRAY-LEADER MACRO-ARRAY 0) 0))
				       (SETQ MACRO-STATE 'INPUT)
				       (GO INPUT-STATE)))
				(GO PLAYBACK-STATE))
			       (OTHERWISE (ERROR "Invalid return from MACRO-IO-TYI" CHAR)))))

		 PLAYBACK-STATE
		    (SETQ CHAR (AR-1 MACRO-ARRAY MACRO-POINTER)
			  MACRO-POINTER (1+ MACRO-POINTER))
		    (COND ((>= MACRO-POINTER (ARRAY-LEADER MACRO-ARRAY 0))
			   (SETQ MACRO-POINTER 0
				 MACRO-COUNT (1+ MACRO-COUNT))
			   (COND ((>= MACRO-COUNT MACRO-TIMES)
				  (SETQ MACRO-STATE 'INPUT)
				  CHAR))))
		    (RETURN CHAR)))))))