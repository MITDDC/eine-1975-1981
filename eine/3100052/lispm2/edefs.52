;Editor Definitions file for the Lisp Machine Editor (EINE)  -*-LISP-*-

;EDITOR special variables.       [S]

(COMMENT EDITOR SPECIAL VARIABLES)

(SPECIAL 

 ED-HAS-BEEN-INITIALIZED-P
 ED-CURRENT-TAB-BUFFER
 ED-PROTOTYPE-TAB-BUFFER
 ED-MOUSE-P			     ;ARE WE USEING THE MOUSE AT ALL?
 MOUSE-TABLET-P			     ;IS IT REALLY THE TABLET?

 ED-OPEN-BUFFER			     ;THE CURRENTLY OPEN BUFFER.
 ED-PREVIOUS-OPEN-BUFFER
 ED-WINDOW			     ;THE ACTIVE WINDOW
 ED-WINDOWS-DISPLAYED		     ;A LIST OF ALL WINDOWS CURRENTLY ON THE SCREEN
 ED-WINDOWS			     ;A LIST OF ALL WINDOWS
 ED-WINDOW-SEARCH-LIST

 ED-FILE-LIST
 ED-SPECIAL-SECTION-LIST
 ED-OUTPOS
 ED-USER-NOTIFIED

 ED-TICK			     ;COUNTER FOR THE REDISPLAY SYSTEM
 ED-BUFFER-GENSYM-COUNTER	     ;COUNTER FOR GENERATING UNIQUE BUFFER NAMES
 ED-BUFFER-ALIST		     ;ASSOCIATES NAMES WITH BUFFERS

 ED-COMMAND-STREAM		     ;I WAS JUST FOLLOWING ORDERS...

 ED-MAIN-WINDOW
 ED-TOP-HALF-WINDOW
 ED-BOTTOM-HALF-WINDOW
 ED-TWO-WINDOW-HACK-LIST 
 ED-WINDOW-HACKING-OK-P
 ED-BUFFER-SIZE                      ;DEFAULT SIZE FOR ED-CREATE-BUFFER

 ED-NUMERIC-ARG 
 ED-NUMERIC-ARG-P
 ED-EXIT-FLAG
 ED-EXIT-PROGRAM-NAME
 ED-INITIAL-MODE-LINE-LIST
 ED-MODE-LINE-LIST		     ;LIST OF ATOMS WHOSE VALUES ARE EITHER NIL OR STRING.
 ED-MODE-EDITOR-NAME		     ;A SYMBOL FOR ABOVE LIST.  NAME OF EDITOR.
 ED-MODE-MODE			     ;ANOTHER SYMBOL FOR ABOVE.  LISP MODE, TEXT MODE, ETC.
 ED-MODE-BUFFER-NAME		     ;YET ANOTHER
 ED-MODE-DEFAULT-FONT		     ;ETC...
 ED-REDISPLAY-LOSES		     ;FLAG.  SET TO T IF YOU CHANGE MODE LINE OR BLINKER 
				     ;VISIBILITY.  ED-COMMAND-LOOP HANDLES IT.
 ED-REDISPLAY-DEGREE
 ED-REDISPLAY-DEGREE-THIS-LEVEL
 ED-SPECIAL-SCREEN-P
 ED-RANDOM-MODE-LIST		     ;FOR SIMPLE USES.  = (ED-RANDOM-MODE).
 ED-RANDOM-MODE			     ;SEE ABOVE.
 ED-MOUSE-MODE-LIST
 ED-FILE-NAME-MODE-LIST
 ED-BUFFER-MODE-LIST

 ED-DEFAULT-FILE-NAME
 ED-LAST-FILE-NAME-TYPED-IN

 ED-SEARCH-RING			     ;RING BUFFER OF DEFAULT SEARCH STRINGS
 ED-SEARCH-RING-MAX-LENGTH	     ;HOW LARGE THE ED-SEARCH-RING IS ALLOWED TO GET
 ED-KILL-RING			     ;RING BUFFER OF KILLED THINGS
 ED-KILL-RING-MAX-LENGTH	     ; (ANALOGOUS)
 ED-POINT-PDL-MAX-LENGTH		     ;HOW LARGE MARK PDL'S MAY GET
 ED-MARK-STAYS			     ;IF THE MARK WAS AROUND, KEEP IT AROUND
 ED-REGION-MARKING-MODE
 ED-SAVE-FONT-NUM		     ; (SPECIAL HACK)
 ED-LAST-COMMAND-CHAR		     ;THE LAST CHARACTER USED AS A COMMAND
 ED-CURRENT-COMMAND-TYPE 
 ED-LAST-COMMAND-TYPE 
 ED-W2-BUFFER
 ED-EXF-FLAG
 TV-WHO-LINE-PROGRAM-NAME TV-ALU-XOR TV-ALU-XOR TV-ALU-ANDCA TV-ALU-IOR TV-BUFFER
 OPEN-CODE-MAP-SWITCH 
 ED-READER-STRING
 ED-REAL-LINE-GOAL-XPOS		     ;GOAL FOR UP- AND DOWN-REAL-LINE, IN RASTER UNITS
 ED-PERMANENT-REAL-LINE-GOAL-XPOS    ;PERMANENT GOAL, IN RASTER UNITS
 ED-RESET-LIST			     ;ALIST OF VARIABLES AND WHAT THEY SHOULD BE RESET TO.

 ED-BUFFER-AREA			     ;AREA IN WHICH BUFFERS LIVE
 ED-LINE-AREA			     ;AREA IN WHICH LINES LIVE
 ED-TEMP-AREA			     ;AREA IN WHICH TEMPORARY BPS LIVE.
 ED-RANDOM-AREA			     ;AREA IN WHICH EVERYTHING ELSE LIVES
 ED-RESET-TEMP-AREA-P
 ED-TEMPORARY-AREA

 ED-IBP-LIMIT-BP		     ;THIS IS USED AS A LIMIT CHECK FOR ED-IBP.
 ED-DBP-LIMIT-BP		     ;   SAME THING FOR ED-DBP.

 ED-COMMENT-STRING		     ;THE STRING USED TO BEGIN A COMMENT
 ED-COMMENT-COLUMN		     ;THE COLUMN IN WHICH WE SHOULD TRY TO START COMMENTS
 ED-COMMENT-ROUND-FUNCTION	     ;FUNCTION TO USE IF CANNOT WIN FOR COMMENT-COLUMN

 ED-DEBUG-P			     ;IS THE SCREEN SET UP WITH A REAL ED-DEBUG-PC-PPR?
 ED-INTERACTIVE-P		     ;BIND THIS TO T IF THE USER IS DOING "^R" EDITING
				     ;     RATER THAT JUST USING EDITOR FUNCTIONS.

 ED-PARANOIA-FLAG
 ED-BARFOLA-FLAG
 ED-ZOWIE-FLAG

 CONSOLE-IO-PC-PPR		     ;THE PC-PPR USED BY READ AND PRINT.
 CONSOLE-IO-PC-PPR-INIT
 ED-CONSOLE-IO-PC-PPR-SAVED	     ;HACK FOR ED-RECOVER.  CANT USE "-INIT" SINCE HE MIGHT 
 ED-SAVED-STANDARD-OUTPUT
 ED-SAVED-STANDARD-INPUT 
 ED-SAVED-ERROR-OUTPUT

 ED-DISPLAY-PC-PPR
 ED-DEBUG-PC-PPR		     ;THE AUXILIARY PC-PPR FOR DISPLAYING ERROR MESSAGES.
 ED-STATUS-PC-PPR
 ED-ECHO-PC-PPR
 ED-ECHO-BLINKER
 ED-DEBUG-STREAM		     ;STREAM FOR DUBUGGING MESSAGES
 ED-STATUS-STREAM		     ;STREAM FOR THE "ECHO AREA."
 ED-ECHO-STREAM
 ED-DISPLAY-STREAM		     ;STREAM TO DISPLAY PC PPR.
 TVFONT				     ;THE TV FONT.
 ED-CURRENT-DEFAULT-FONT	     ;FONT NUMBER USED BY ED-COM-SELF-INSERT
 ED-KEYBOARD-IO-UNRCHF

 ED-MINI-BUFFER
 ED-MINI-BUFFER-WINDOW		     ;THE MINI-BUFFER'S WINDOW.


 ED-COMMAND-DISPATCH-TABLE	     ;THE TABLE OF FUNCTIONS ON EACH KEY IN "^R MODE"
 ED-CONTROL-X-DISPATCH-TABLE	     ;DISPATCH TABLE FOR THE ^X COMMAND
 ED-MOUSE-DISPATCH-TABLE	     ;DISPATCH TABLE FOR MOUSE COMMANDS
 ED-INITIAL-MOUSE-DISPATCH-TABLE
 ED-EXTENDED-COMMAND-ALIST	     ;ASSOC-LIST OF EXTENDED COMMANDS
 ED-WORD-SYNTAX-TABLE		     ;SYNTAX OF EACH LETTER FOR WORD AND LIST COMMANDS,
 ED-LIST-SYNTAX-TABLE		     ;    LIKE ..D IN TECO.
 ED-INITIAL-COMMAND-DISPATCH-TABLE   ;THESE ARE LISTS FROM WHICH TO INITIALIZE
 ED-INITIAL-WORD-SYNTAX-LIST	     ;    THE ABOVE TABLES.  THERE WILL EVENTUALLY BE
 ED-INITIAL-LIST-SYNTAX-LIST	     ;     AN "EDIT ..D" FEATURE LIKE THE ONE EMACS HAS.
 ED-INITIAL-CONTROL-X-DISPATCH-TABLE
 ED-RPCNT			     ;USED FOR SETTING UP THESE TABLES.
 ED-BLANK-LIST			     ;LIST OF LETTERS WHICH THE EDITOR CONSIDERS
				     ;   "BLANKS".  USUALLY SPACES AND TABS.
 ED-GLOBAL-WINDOW-VSP		     ;VSP USED WHEN CREATING PCS PPR.

 ED-METER-LINE			     ;TOTAL NUMBER OF LINES AND BUFFERS CREATED.
 ED-METER-BUFFER		     ;     THIS IS FOR METERING PURPOSES.

 ED-BUFFER-NAME-PROPERTIES 
 ED-MOUSE-VISIBILITY
    ;From EMOUSE
 MOUSE-X MOUSE-Y MOUSE-REGION MOUSE-BLINKER ARROW MOUSE-ROLLOVER
 TV-SCREEN-WIDTH TV-SCREEN-HEIGHT
   ;THESE ARE THE SYMBOLIC NAMES FOR THE POSSIBILITIES FOR EACH LETTER IN
   ;     ED-WORD-SYNTAX-TABLE AND ED-LIST-SYNTAX-TABLE.  THEIR MEANINGS
   ;     SHOULD BE PRETTY MUCH SELF-EXPLANITORY.
 ED-LIST-OPEN ED-LIST-CLOSE ED-LIST-SINGLE-QUOTE ED-LIST-DOUBLE-QUOTE 
 ED-LIST-SLASH ED-LIST-ALPHABETIC ED-LIST-DELIMITER ED-WORD-ALPHABETIC ED-WORD-DELIMITER

   ED-DIS-NONE ED-DIS-BPS ED-DIS-BUFFER ED-DIS-SCREEN 43VXMS ED-SPACES-STRING
   ED-MARK-REVERSE-VIDEO ED-MARK-UNDERLINE NORMAL MOVES TEMP FILE-ERROR TV-BEEP
   SPECIAL-UNDO-LIST SPECIAL-UNDO-SAVE-FLAG
)

; Declarations for the basic editor data structures.

(COMMENT DEFINITIONS OF EDITOR DATA STRUCTURES)

; The array leader of a buffer

(DEFSTRUCT (ED-MAKE-BUFFER ED-OPEN-BUFFER) ARRAY-LEADER
	(ED-BUFFER-FILL-POINTER 0)	; The fill-pointer. (Buffer length.)
	(ED-BUFFER-FUNCTION		; The named-structure-function.
	 'ED-BUFFER)
	ED-BUFFER-NAME			; (A symbol.)
	(ED-BUFFER-POINT		; The point.
	 (ED-BP 0 LINE 'NORMAL))
	(ED-BUFFER-MARK			; The mark.
	 (ED-BP 0 LINE 'NORMAL))
	ED-BUFFER-POINT-PDL		; The mark pdl.
	ED-BUFFER-MARK-P		; Is there a mark at the moment?
	ED-BUFFER-PATHNAME		; NIL, or a file-symbol.
	ED-BUFFER-WRITTEN-P		; --FLUSH!!--
	(ED-BUFFER-STREAM		; A buffer stream for this buffer.
	 (ED-MAKE-BUFFER-STREAM (ED-BP 0 LINE 'NORMAL)))
	ED-BUFFER-BLINKER-ALIST		; (BP BLINK-FUNCTION VISIBILITY) list.
        				;  Does not include the point blinker.
	(ED-BUFFER-BOB-BP		; A BP pointing to the beg of buffer.
	 (ED-BP 0 LINE 'NORMAL))
	(ED-BUFFER-EOB-BP		; A BP pointing to the end of buffer.
	 (ED-BP 0 LINE 'MOVES))
	(ED-BUFFER-PLIST		; --FLUSH!!--
	 (NCONS NIL))
	(ED-BUFFER-TYPE NIL)		; One of the symbols NIL, FILE or SECTION.
	ED-BUFFER-CHILDREN		; Subnodes of this node, a la NLS.  A list of buffers.
	ED-BUFFER-FATHER		; Superior of this node (a buffer), or NIL.
	)

; Array leader of a line

(DEFSTRUCT (ED-MAKE-LINE) ARRAY-LEADER
	(ED-LINE-FILL-POINTER 0)	; THE FILL POINTER
	ED-LINE-BUFFER			; THE BUFFER
	(ED-LINE-NUMBER -1)		; THE LINE NUMBER OF THIS LINE IN THE BUFFER
	ED-LINE-BUFFER-POINTER-LIST     ; THE LIST OF BUFFER POINTERS
	(ED-LINE-MUNGED ED-TICK)	; LAST TIME MUNGED.
        )

; A buffer pointer

(DEFSTRUCT ED-DEFAULT-BP LIST
	ED-BP-LINE			; THE LINE
	ED-BP-CHAR-POS			; THE CHARACTER POSITION
	ED-BP-STATUS			; TEMP, NORMAL, OR MOVES
	)

; Array leader of a display window

(DEFSTRUCT (ED-MAKE-WINDOW ED-WINDOW) ARRAY-LEADER
	ED-WINDOW-FILL-POINTER		; THE FILL POINTER
	ED-WINDOW-BLIND                 ; "PULL DOWN THE BLINDS" FEATURE [ed-recurse knows that
	ED-WINDOW-PC-PPR		; ASSOCIATED PIECE OF PAPER        this is #1 !!!]
	ED-WINDOW-BUFFER		; ASSOCIATED BUFFER
	ED-WINDOW-SAVED-BP		; WHERE THE POINT WAS WHEN WE LAST LEFT THIS WINDOW.
	ED-WINDOW-SAVED-3-LIST
	ED-WINDOW-POINT-BLINKER		; BLINKER WHICH SHOW THE USER WHERE THE POINT IS
	ED-WINDOW-OTHER-BLINKERS	; LIST OF 3-LISTS: (BP BLINKER VISIBILITY) (SEE ED-W-3)
	ED-WINDOW-MAX-RASTER		; THESE ARE THE "ALLOWABLE" LIMITS FOR THE
	ED-WINDOW-MIN-RASTER		;    CURSOR, IN RASTER LINES.
	ED-WINDOW-MAX-RESET-RASTER	; THERE ARE WHERE TO GO WHEN THE "ALLOWABLE"
	ED-WINDOW-MIN-RESET-RASTER	;    ARE EXCEEDED
	ED-WINDOW-CENTER-RASTER		; WHERE TO PUT THE CURSOR TO CENTER IT, IN RASTERS
	ED-WINDOW-END-RASTER	        ; LIKE FS%END IN TECO...
	ED-WINDOW-TOP-LINE-DISPLAYED	; THE LINE AT THE TOP OF THE WINDOW
	(ED-WINDOW-UNMUNGED (ED-TICK))	; ED-TICK AT THE LAST REDISPLAY OF THIS WINDOW.
	(ED-WINDOW-REGION-MARKING-HEIGHT 0)	;HEIGHT OF REGION MARKING (DEFAULTS TO 1)
	(ED-WINDOW-REGION-MARKING-OFFSET 0)	;OFFSET OF REGION MARKING (DEFAULTS TO 10.)
	ED-WINDOW-BUFFER-ALIST		; ALIST of buffers visible in this window.
					; Only the CARs are used right now.
	ED-WINDOW-BUFFERS-DISPLAYED	; The tail of BUFFER-ALIST starting with the buffer
					; which TOP-LINE-DISPLAYED refers to.
	ED-WINDOW-VIEWSPEC		; The current viewspec.  Not yet defined.
	ED-WINDOW-VIEWED-BUFFER		; The buffer to which the viewspec was applied
					; to produce the current ED-WINDOW-BUFFER-ALIST.
)

(DEFMACRO ED-ILDB (BP)
   `(ED-BP-CHAR (ED-IBP ,BP)))

(DEFMACRO ED-DLDB (BP)
   `(ED-BP-CHAR-BEFORE (ED-DBP ,BP)))

(DEFMACRO ED-MOVE-POINT X
   `(ED-MOVE-BP (ED-BUFFER-POINT) ,@X))

(DEFMACRO LOCAL-MAPC ((IGNORED FCTN) LIST)
   `(DO L ,LIST (CDR L) (NULL L)
      (,FCTN (CAR L))))

(DEFMACRO ED-BP-LINE-NUM (BP)
   `(ED-LINE-NUMBER (ED-BP-LINE ,BP)))

(DEFMACRO ED-BIND-MODE-LINE (MODE MODE-LIST . REST)
   `((LAMBDA (ED-MODE-LINE-LIST ED-RANDOM-MODE)
	     (ED-UPDATE-MODE-LINE)
             . ,REST)
     ,(COND ((NULL MODE-LIST) 'ED-RANDOM-MODE-LIST)
	    (T MODE-LIST))
     ,MODE))

(DEFMACRO ED-BP-BUFFER (BP)
   `(ED-LINE-BUFFER (ED-BP-LINE ,BP)))

;;; (ED-FOR-CHARS <bp> <variable> <form1> <form2> ...)
;;; loops over every character in the buffer, starting at <bp>.
;;; <variable> will be set to the character, and then the forms
;;; are evaluated.  Also, the variables LINE-NUM, CHAR-POS, and
;;; LINE will be set to the conventional things.
;;; Use: (example)
;;; (ED-FOR-CHARS (ED-BUFFER-POINT) THIS-CHAR
;;;                (COND ((CHAR-EQUAL THIS-CHAR 101) (ED-BARF))))

(DEFMACRO ED-FOR-CHARS (BP-EXP VAR . BODY)
  `(LET ((FOR-BP ,BP-EXP))
	 (DO ((LINE-NUM (ED-BP-LINE-NUM FOR-BP) (1+ LINE-NUM))
	      (LIM-LINE-NUM (ED-BUFFER-FILL-POINTER (ED-BP-BUFFER FOR-BP)))
	      (LINE)
	      (FIRST-CHAR-POS (ED-BP-CHAR-POS FOR-BP) 0))
	     ((>= LINE-NUM LIM-LINE-NUM) NIL)
	   (SETQ LINE (AR-1 ED-OPEN-BUFFER LINE-NUM))
	   (DO ((CHAR-POS FIRST-CHAR-POS (1+ CHAR-POS))
		(,VAR)
		(LIM-CHAR-POS (ED-LINE-FILL-POINTER LINE)))
	       ((>= CHAR-POS LIM-CHAR-POS))
	     (SETQ ,VAR (AR-1 LINE CHAR-POS))
	     ,@BODY))))

