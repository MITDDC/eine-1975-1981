;;; This file is part of EINE, the Lisp Machine editor.        -*-LISP-*-
;;; For more information see LISPM2;EINE INFO.

;; This file contains functions for hacking multiple windows and
;;   creating and playing with windows, and for multiple buffers.

(DECLARE (SETQ RETAIN-VARIABLE-NAMES-SWITCH 'ARGS))
(DECLARE (SETQ OPEN-CODE-MAP-SWITCH T))

(DEFUN ED-COM-TWO-WINDOWS (CHR)
    (OR ED-WINDOW-HACKING-OK-P (ED-BARF "You may not hack windows now."))
    (AND (MEMQ ED-TOP-HALF-WINDOW ED-WINDOWS-DISPLAYED)
	 (ED-BARF "You already have two windows -- ED-COM-TWO-WINDOWS"))
    
    (ED-SELECT-BUFFER ED-TOP-HALF-WINDOW (ED-WINDOW-BUFFER ED-WINDOW))

    (COND ((NULL (ED-WINDOW-BUFFER ED-BOTTOM-HALF-WINDOW))
	   (SETQ ED-W2-BUFFER (ED-CREATE-BUFFER 'W2))
	   (ED-SELECT-BUFFER ED-BOTTOM-HALF-WINDOW ED-W2-BUFFER)))

    (ED-OUTLINE-WINDOW ED-WINDOW TV-ALU-ANDCA)

    (ED-SELECT-WINDOWS ED-BOTTOM-HALF-WINDOW ED-TOP-HALF-WINDOW)
    (ED-WINDOW-SAVE-BP ED-TOP-HALF-WINDOW)
    (SETQ ED-REDISPLAY-LOSES T)
    (SETQ ED-MARK-STAYS T)
    ED-DIS-SCREEN)

(DEFUN ED-COM-OTHER-WINDOW (CHR &AUX TEM)
    (OR ED-WINDOW-HACKING-OK-P (ED-BARF "You may not hack windows now."))
    (SETQ ED-MARK-STAYS T)
    (SELECT ED-WINDOW
	    (ED-MAIN-WINDOW
	     (COND ((OR (NOT (BOUNDP 'ED-BOTTOM-HALF-WINDOW))
			(NULL (SETQ TEM (ED-WINDOW-BUFFER ED-BOTTOM-HALF-WINDOW))))
		    (ED-BARF "There is no other window -- ED-COM-OTHER-WINDOW")))
	     (ED-SELECT-BUFFER ED-BOTTOM-HALF-WINDOW (ED-WINDOW-BUFFER ED-MAIN-WINDOW))
	     (ED-SELECT-BUFFER ED-MAIN-WINDOW TEM)
	     (ED-OPEN-BUFFER (ED-WINDOW-BUFFER ED-WINDOW))
	     (SETQ ED-MARK-STAYS T)
	     ED-DIS-SCREEN)
	    (ED-TOP-HALF-WINDOW
	     (ED-SELECT-WINDOW ED-BOTTOM-HALF-WINDOW)
	     (SETQ ED-REDISPLAY-LOSES T)		;To make blinker blink.
	     ED-DIS-BPS)
	    (ED-BOTTOM-HALF-WINDOW
	     (ED-SELECT-WINDOW ED-TOP-HALF-WINDOW)
	     (SETQ ED-REDISPLAY-LOSES T)		;To make blinker blink.
	     ED-DIS-BPS)
	    (OTHERWISE
	     (ED-BARF "Not in two windows mode."))))

(DEFUN ED-COM-ONE-WINDOW (CHR)
    (OR ED-WINDOW-HACKING-OK-P (ED-BARF "You may not hack windows now."))
    (AND (= ED-WINDOW ED-MAIN-WINDOW)
	 (ED-BARF "You are already in one-window mode.  -- ED-COM-ONE-WINDOW"))
    (ED-SELECT-BUFFER ED-MAIN-WINDOW (ED-WINDOW-BUFFER ED-TOP-HALF-WINDOW))
    (ED-OUTLINE-WINDOW ED-TOP-HALF-WINDOW TV-ALU-ANDCA)
    (ED-OUTLINE-WINDOW ED-BOTTOM-HALF-WINDOW TV-ALU-ANDCA)
    (ED-SELECT-WINDOWS ED-MAIN-WINDOW)
    (SETQ ED-REDISPLAY-LOSES T)
    (SETQ ED-MARK-STAYS T)
    ED-DIS-SCREEN)

(COMMENT MULTIPLE WINDOW HACKING)

; Makes WINDOW be the current window, and opens its buffer.  Also
;  does various hairy hacking of window-lists and shading, may be a loser...
; Returns T if window was not originally on the ED-WINDOWS-DISPLAYED list.
(DEFUN ED-SELECT-WINDOW (WINDOW &AUX BP MUST-CLEAR)
    (OR ED-WINDOW-HACKING-OK-P (ED-BARF "You may not hack windows now."))
    (PROG1 (NOT (MEMQ WINDOW ED-WINDOWS-DISPLAYED))
	   (COND ((NEQ ED-WINDOW WINDOW)
		  (ED-WINDOW-SAVE-BP ED-WINDOW)
		  (SETQ ED-WINDOW WINDOW)
		  (ED-OPEN-BUFFER (ED-WINDOW-BUFFER WINDOW))
		  (COND ((SETQ BP (ED-WINDOW-SAVED-BP WINDOW))
			 (ED-MOVE-POINT BP)
			 (SETF (ED-LINE-BUFFER-POINTER-LIST (ED-BP-LINE BP))
			       (DELQ BP (ED-LINE-BUFFER-POINTER-LIST (ED-BP-LINE BP))))))
		  (SETQ ED-WINDOW-SEARCH-LIST
			(CONS WINDOW (DELQ WINDOW ED-WINDOW-SEARCH-LIST)))
		  (DO W ED-WINDOWS-DISPLAYED (CDR W) (NULL W)
		      (COND ((AND (ED-WINDOWS-OVERLAP-P WINDOW (CAR W))
				  (NEQ WINDOW (CAR W)))
			     (SETQ ED-WINDOWS-DISPLAYED (DELQ (CAR W) ED-WINDOWS-DISPLAYED))
			     (SETQ MUST-CLEAR T)	;Flag that we have done shading.
			     (ED-WINDOW-SHADE (CAR W)))))
		  (AND MUST-CLEAR
		       (TV-CLEAR-PC-PPR (ED-WINDOW-PC-PPR WINDOW)))
		  (OR (MEMQ WINDOW ED-WINDOWS-DISPLAYED)
		      (SETQ ED-WINDOWS-DISPLAYED (CONS WINDOW ED-WINDOWS-DISPLAYED)))))))

(DEFUN ED-WINDOW-SAVE-BP (W)
    (SETF (ED-WINDOW-SAVED-BP W)
	  (ED-COPY-BP (ED-BUFFER-POINT (ED-WINDOW-BUFFER W)) 'NORMAL)))


(DEFUN ED-WINDOW-SHADE (W &AUX P)
    (SETQ P (ED-WINDOW-PC-PPR W))
    (TV-OPEN-PC-PPR P 'ED-WINDOW-SHADE-INTERNAL P))

(DEFUN ED-WINDOW-SHADE-INTERNAL (P &AUX (B (PC-PPR-BOTTOM-MARGIN P))
				        (R (PC-PPR-RIGHT-MARGIN P)))
    (DO Y (PC-PPR-TOP-MARGIN P) (+ Y 3) (>= Y B)
      (DO X (+ (PC-PPR-LEFT-MARGIN P) (LOGAND Y 3)) (+ X 3) (>= X R)
	 (AS-2 1 TV-BUFFER X Y))))

(DEFUN ED-SELECT-WINDOWS (WINDOW &REST WINDOWS)
    (OR ED-WINDOW-HACKING-OK-P (ED-BARF "You may not hack windows now."))
    (AND ED-WINDOW (ED-WINDOW-SAVE-BP ED-WINDOW))
    (SETQ ED-WINDOW WINDOW)
    (ED-OPEN-BUFFER (ED-WINDOW-BUFFER WINDOW))
    (SETQ ED-WINDOWS-DISPLAYED (APPEND (NCONS WINDOW) WINDOWS NIL))
    (SETQ ED-WINDOW-SEARCH-LIST (APPEND ED-WINDOWS-DISPLAYED NIL)))

(DEFUN ED-WINDOWS-OVERLAP-P (WINDOW1 WINDOW2 &AUX (P1 (ED-WINDOW-PC-PPR WINDOW1))
				     (P2 (ED-WINDOW-PC-PPR WINDOW2)))
   (NOT (OR (< (+ (PC-PPR-RIGHT-MARGIN P1) 2) (- (PC-PPR-LEFT-MARGIN P2) 2))
	    (< (+ (PC-PPR-RIGHT-MARGIN P2) 2) (- (PC-PPR-LEFT-MARGIN P1) 2))
	    (< (+ (PC-PPR-BOTTOM-MARGIN P1) 2) (- (PC-PPR-TOP-MARGIN P2) 2))
	    (< (+ (PC-PPR-BOTTOM-MARGIN P2) 2) (- (PC-PPR-TOP-MARGIN P1) 2)))))


(COMMENT MULTIPLE BUFFER HACKING)

;;; This is used when VISIBLY changing the open buffer: only when the user will see it.
;;; Don't use this if you are changing ed-open-buffer temporarily or for internal
;;; reasons such as mini-buffer stuff.
(DEFUN ED-OPEN-BUFFER (BUFFER &AUX TEM)
    (OR (EQ BUFFER ED-OPEN-BUFFER)
	(SETQ ED-PREVIOUS-OPEN-BUFFER ED-OPEN-BUFFER))
    (SETQ ED-OPEN-BUFFER BUFFER)
    (AND (SETQ TEM (ED-BUFFER-PATHNAME))
	 (SETQ ED-DEFAULT-FILE-NAME (STRING TEM)))
    BUFFER)


; The BUFFER-BLINKER-ALIST contains elements of the form  A = (BP BLINK-FUNCTION VISIBILITY).
; The WINDOW-OTHER-BLINKERS contains elements of the form B = (BP BLINKER VISIBILITY).

(DEFUN ED-SELECT-BUFFER (WINDOW BUFFER &AUX A B TEM BLINKER)
    (SETF (ED-WINDOW-BUFFER WINDOW) BUFFER)
    (OR (ASSQ BUFFER (ED-WINDOW-BUFFER-ALIST WINDOW))
	(SETF (ED-WINDOW-BUFFER-ALIST WINDOW) (LIST (NCONS BUFFER))))
    (SETQ TEM (ED-WINDOW-OTHER-BLINKERS WINDOW))
    (DO J TEM (CDR J) (NULL J)
      (TV-SET-BLINKER-VISIBILITY (SECOND (CAR J)) NIL)
      (RPLACA (REST2 (CAR J)) NIL))
    (DO L (ED-BUFFER-BLINKER-ALIST BUFFER) (CDR L) (NULL L)
      (SETQ A (CAR L))
      (AND (THIRD A)
	   (NOT (DO J TEM (CDR J) (NULL J)
		  (SETQ B (CAR J))
		  (COND ((EQ (FIRST A) (FIRST B))		;IF THEY HAVE THE SAME BP
			 (COND ((EQ (SECOND A)
				    (TV-BLINKER-FUNCTION (SECOND B)))
				(TV-SET-BLINKER-VISIBILITY (SECOND B) (THIRD A))
				(RPLACA (REST2 B) (THIRD A))
				(RETURN T))
			       (T
				(SETQ TEM (DELQ J TEM))))))))	;ALLOW ONLY ONE BLINKER ON A BP
	   (SETQ BLINKER (TV-DEFINE-BLINKER (ED-WINDOW-PC-PPR WINDOW)
					    'FUNCTION (SECOND A)
					    'VISIBILITY (THIRD A)))
	   (SETQ TEM (CONS (LIST (FIRST A) BLINKER (THIRD A))
			   TEM))))
    (SETF (ED-WINDOW-OTHER-BLINKERS WINDOW) TEM))

;; (Can't call ED-GET-BUFFER-BY-NAME because IMPOSSIBLE-IS-OK.)
(DEFUN ED-COM-SELECT-BUFFER (CHR)
    (ED-SELECT-BUFFER-READING-NAME "Select buffer:"))

;; Call this on a prompt.  Selects a buffer as the current one and opens it,
;; or doesn't if user quits out.  Returns a redisplay degree.
(DEFUN ED-SELECT-BUFFER-READING-NAME (PROMPT &AUX TEM TEM1 RET)
    (MULTIPLE-VALUE (TEM TEM1)
       (ED-COMPLETING-READ-PROMPT PROMPT ED-BUFFER-MODE-LIST ED-BUFFER-ALIST
                                  ED-COMMAND-STREAM T T ED-DISPLAY-PC-PPR))
    (SETQ ED-REDISPLAY-LOSES T)
    (SETQ ED-MARK-STAYS T)
    (COND ((NULL TEM) (TV-BEEP) ED-DIS-NONE)		;Quit.
	  ((ZEROP TEM) ED-DIS-NONE)			;Over-rubout.
	  ((STRINGP TEM)
	   (ED-SELECT-BUFFER ED-WINDOW
			     (ED-OPEN-BUFFER 
			      (COND ((ZEROP (ARRAY-ACTIVE-LENGTH TEM))
                                     (OR ED-PREVIOUS-OPEN-BUFFER (ED-BARF))
				     ED-PREVIOUS-OPEN-BUFFER)
				    (T (ED-CREATE-BUFFER (INTERN TEM))))))
	   ED-DIS-BUFFER)
	  (T (ED-SELECT-BUFFER ED-WINDOW (ED-OPEN-BUFFER (CDR TEM)))
	     ED-DIS-BUFFER
	     )))

(DEFUN ED-COM-RENAME-BUFFER (CHR &AUX TEM)
    (ED-BIND-MODE-LINE "Rename buffer:" ED-BUFFER-MODE-LIST
	     (TV-SET-CURSORPOS ED-ECHO-PC-PPR 0 0)
	     (SETQ TEM (ED-SIMPLE-READER ED-ECHO-PC-PPR))
	     ;(TV-SET-BLINKER-VISIBILITY MOUSE-BLINKER ED-MOUSE-VISIBILITY)
	     (COND ((NULL TEM) (ED-BARF))
		   ((GET (SETQ TEM (INTERN TEM)) 'ED-BUFFER)
		    (ED-BARF "That name has already been used."))
		   (T (ED-RENAME-BUFFER ED-OPEN-BUFFER TEM))))
    (SETQ ED-REDISPLAY-LOSES T)
    (SETQ ED-MARK-STAYS T)
    ED-DIS-NONE) 
 
(DEFUN ED-COM-CREATE-BUFFER (CHR &AUX TEM)
    (ED-BIND-MODE-LINE "Create buffer:" ED-BUFFER-MODE-LIST
	     (TV-SET-CURSORPOS ED-ECHO-PC-PPR 0 0)
	     (SETQ TEM (ED-SIMPLE-READER ED-ECHO-PC-PPR))
	     ;(TV-SET-BLINKER-VISIBILITY MOUSE-BLINKER ED-MOUSE-VISIBILITY)
	     (COND ((NULL TEM) (ED-BARF))
		   (T (SETQ TEM (ED-CREATE-BUFFER (INTERN TEM)))
		      (ED-SELECT-BUFFER ED-WINDOW TEM)
		      (ED-OPEN-BUFFER TEM))))
    (SETQ ED-REDISPLAY-LOSES T)
    (SETQ ED-MARK-STAYS T)
    ED-DIS-BUFFER)

(DEFUN ED-COM-LIST-BUFFERS (CHR)
    (TV-CLEAR-PC-PPR ED-DISPLAY-PC-PPR)
    (FORMAT-STRING  ED-DISPLAY-STREAM
                    "~%Buffers in EINE:~%  Buffer name:        File name:~2%")
    (DO L ED-BUFFER-ALIST (CDR L) (NULL L)
      (FORMAT-STRING ED-DISPLAY-STREAM "  ~24A~5X~S~%"
		     (CAAR L) (ED-BUFFER-PATHNAME (CDAR L))))
    (SETQ ED-SPECIAL-SCREEN-P T)
    ED-DIS-NONE)
