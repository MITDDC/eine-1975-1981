;; EINE: The LISP Machine Editor. (EINE is not EMACS!)       -*-LISP-*-

;;; This file is part of EINE, the Lisp Machine editor.
;;; For more information see LISPM2;EINE INFO.

(DECLARE (SETQ RETAIN-VARIABLE-NAMES-SWITCH 'ARGS))
(DECLARE (SETQ OPEN-CODE-MAP-SWITCH T))

(OR (BOUNDP 'ED-HAS-BEEN-INITIALIZED-P)
    (SETQ ED-HAS-BEEN-INITIALIZED-P NIL))
(OR (BOUNDP 'ED-TICK) (SETQ ED-TICK 1))

(SETQ ED-BLANK-LIST '(40 211))
(SETQ ED-PARANOIA-FLAG NIL ED-DEBUG-P T ED-GLOBAL-WINDOW-VSP 2
      ED-LIST-OPEN 1 ED-LIST-CLOSE 2 ED-LIST-SINGLE-QUOTE 3 ED-LIST-DOUBLE-QUOTE 4 
      ED-LIST-SLASH 5 ED-LIST-ALPHABETIC 6 ED-LIST-DELIMITER 7
      ED-WORD-ALPHABETIC 0 ED-WORD-DELIMITER 1 
      ED-SEARCH-RING-MAX-LENGTH 3 ED-KILL-RING-MAX-LENGTH 10 ED-POINT-PDL-MAX-LENGTH 10 
      ED-BUFFER-GENSYM-COUNTER 0 ED-BUFFER-ALIST NIL ED-FILE-LIST NIL
      )

(SETQ ED-DIS-NONE 0
      ED-DIS-BPS 2
      ED-DIS-BUFFER 4
      ED-DIS-SCREEN 6)

(SETQ ED-BUFFER-NAME-PROPERTIES '(ED-RANGE ED-TICK ED-BUFFER))

(ENDF HEAD)

; Basic functions for creation of editor data structures.

(COMMENT FUNCTIONS FOR CREATION OF EDITOR DATA STRUCTURES.)

;NAME should be a symbol.  NIL for gensymming a name, T for no name at all.
(DEFUN ED-CREATE-BUFFER (&OPTIONAL NAME (SIZE ED-BUFFER-SIZE) &AUX LINE BUFFER POINT)
   (COND ((NULL NAME)
	  (SETQ NAME (INTERN (ED-GENERATE-BUFFER-NAME)))
	  (PUTPROP NAME T 'ED-ANONYMOUS))
	 ((STRINGP NAME)
	  (SETQ NAME (INTERN NAME))))
   (SETQ ED-METER-BUFFER (1+ ED-METER-BUFFER))
   (SETQ LINE (ED-CREATE-LINE 'ART-STRING))		; MUST START WITH ONE LINE, SO POINT 
							; AND MARK CAN EXIST
   (SETF (ED-LINE-NUMBER LINE) 0)			;
   (SETQ BUFFER (ED-MAKE-BUFFER () (ED-BUFFER-AREA ART-Q SIZE NIL NIL NIL T)))
   (SETF (ED-LINE-BUFFER LINE) BUFFER)
   (COND ((NEQ NAME T)
	  (SETF (ED-BUFFER-NAME BUFFER) NAME)
	  (PUTPROP NAME BUFFER 'ED-BUFFER)
	  (PUSH (CONS NAME BUFFER) ED-BUFFER-ALIST)
	  ))
   (ARRAY-PUSH BUFFER LINE)				; AND INSTALL THE LINE
   BUFFER)

(DEFUN ED-GENERATE-BUFFER-NAME ()
    (FORMAT-STRING NIL "BUFFER-~D" (SETQ ED-BUFFER-GENSYM-COUNTER
					 (1+ ED-BUFFER-GENSYM-COUNTER))))


;The NAMED-STRUCTURE-SYMBOL for buffers is ED-BUFFER.
(DEFUN ED-BUFFER (OP X &REST ARGS)
    (SELECTQ OP
	     (WHICH-OPERATIONS '(PRINT))
	     (PRINT
	      (FORMAT-STRING (CAR ARGS) "#<EINE Buffer ~S>" (ED-BUFFER-NAME X)))
	     (OTHERWISE (ERROR OP "I have never heard of "))))

(DEFUN ED-RENAME-BUFFER (BUFFER NEW-NAME &AUX OLD-NAME TEM)
    (SETQ OLD-NAME (ED-BUFFER-NAME BUFFER))
    (COND (OLD-NAME
	   (AND (SETQ TEM (ASSQ OLD-NAME ED-BUFFER-ALIST))
		(SETQ ED-BUFFER-ALIST (DELQ TEM ED-BUFFER-ALIST)))
	   (DO L ED-BUFFER-NAME-PROPERTIES (CDR L) (NULL L)
	     (SETQ TEM (CAR L))
	     (PUTPROP NEW-NAME (GET OLD-NAME TEM) TEM)
	     (REMPROP OLD-NAME TEM))
	   (COND ((EQ (ED-BUFFER-TYPE BUFFER) 'SECTION)
		  (SETQ TEM (RASSOC OLD-NAME (GET (ED-BUFFER-PATHNAME BUFFER)
						  'ED-FILE-FUNCTION-LIST)))
		  (RPLACD TEM NEW-NAME)
		  (OR (MEMQ (CAR TEM) ED-SPECIAL-SECTION-LIST)
		      (RPLACA TEM NEW-NAME))))
	   ))
    (SETF (ED-BUFFER-NAME BUFFER) NEW-NAME)
    (PUTPROP NEW-NAME BUFFER 'ED-BUFFER)
    (PUSH (CONS NEW-NAME BUFFER) ED-BUFFER-ALIST)
    BUFFER)

(DEFUN ED-CREATE-LINE (ARRAYTYPE &OPTIONAL (SIZE 120.))
       (SETQ ED-METER-LINE (1+ ED-METER-LINE))
       (ED-MAKE-LINE () (ED-LINE-AREA ARRAYTYPE SIZE NIL NIL NIL T)))


(DEFUN ED-BP (CHAR-POS LINE STATUS &AUX BP)
    (SETQ BP (COND ((EQ STATUS 'TEMP)
		    (LIST-IN-AREA ED-TEMP-AREA LINE CHAR-POS 'TEMP))
		   (T
		    (LIST LINE CHAR-POS STATUS))))
    (OR (EQ STATUS 'TEMP)
	 (SETF (ED-LINE-BUFFER-POINTER-LIST LINE)
	       (CONS BP (ED-LINE-BUFFER-POINTER-LIST LINE))))
    BP)

(DEFUN ED-CREATE-WINDOW (NAME TOP BOTTOM &OPTIONAL (LEFT 0) (RIGHT TV-SCREEN-WIDTH)
			      (FONT-MAP (LIST TVFONT))
			      &AUX SIZE WINDOW PC-PPR HEIGHT)
   (SETQ PC-PPR
	 (TV-DEFINE-PC-PPR NAME FONT-MAP 'TOP TOP 'BOTTOM BOTTOM 'VSP ED-GLOBAL-WINDOW-VSP
			   'MORE-P NIL 'BLINKER-P NIL 'END-SCREEN-FCN 'ED-TRUE
			   'LEFT LEFT 'RIGHT RIGHT 'INTEGRAL-P T 'LEFT-MARGIN 2
			   'RIGHT-MARGIN 2 'TOP-MARGIN 2 'BOTTOM-MARGIN 2))
   (SETQ SIZE (- BOTTOM TOP))
   (SETQ HEIGHT (// SIZE (PC-PPR-LINE-HEIGHT PC-PPR)))
   (AND (BOUNDP '43VXMS)
	(AS-1 43VXMS (PC-PPR-FONT-MAP PC-PPR) 7))
   (SETQ WINDOW
	 (ED-MAKE-WINDOW
	  (ED-WINDOW-FILL-POINTER HEIGHT
           ED-WINDOW-PC-PPR PC-PPR
	   ED-WINDOW-POINT-BLINKER (TV-DEFINE-BLINKER PC-PPR 'VISIBILITY NIL) 
	   ED-WINDOW-MAX-RASTER SIZE
	   ED-WINDOW-MIN-RASTER 0
	   ED-WINDOW-MAX-RESET-RASTER (// (* SIZE 10.) 100.)			
	   ED-WINDOW-MIN-RESET-RASTER (// (* SIZE 90.) 100.)
	   ED-WINDOW-CENTER-RASTER (// SIZE 2)
	   ED-WINDOW-END-RASTER (// (* SIZE 75.) 100.)
	   ED-WINDOW-TOP-LINE-DISPLAYED 0
	   )
	  (ED-RANDOM-AREA 'ART-Q (LIST HEIGHT 3) NIL NIL NIL NIL)))
   ((LAMBDA (ED-WINDOW)
	    (SELECTQ ED-REGION-MARKING-MODE
		     (ED-MARK-UNDERLINE
		      (ED-COM-MARK-UNDERLINE NIL))
		     (ED-MARK-REVERSE-VIDEO
		      (ED-COM-MARK-REVERSE-VIDEO NIL))))
    WINDOW)
   (SETQ ED-WINDOWS (CONS WINDOW ED-WINDOWS))
   WINDOW)

(COMMENT INITIALIZATION)

(DEFUN ED-INITIALIZE (&OPTIONAL (ARG NIL) &AUX ROOM)
       (SETQ ED-DEBUG-P (NOT ARG))
       (SETQ ROOM (AREA-FREE-POINTER DEFAULT-ARRAY-AREA))
       (SETQ 
;-- Sophisticated editor storage allocation system.
             ED-BUFFER-AREA        DEFAULT-ARRAY-AREA
	     ED-LINE-AREA          DEFAULT-ARRAY-AREA
	     ED-RANDOM-AREA        DEFAULT-ARRAY-AREA
	     ED-TEMP-AREA          DEFAULT-ARRAY-AREA

	     ED-RESET-TEMP-AREA-P  NIL
             ED-OPEN-BUFFER        NIL
	     ED-WINDOW             NIL
	     ED-WINDOWS-DISPLAYED  NIL
	     ED-WINDOWS            NIL
	     ED-WINDOW-SEARCH-LIST NIL
	     ED-COMMAND-STREAM     'ED-KEYBOARD-IO
	     ED-PERMANENT-REAL-LINE-GOAL-XPOS NIL
	     ED-REAL-LINE-GOAL-XPOS 0
	     ED-BUFFER-SIZE        120 
	     ED-METER-LINE         0
	     ED-METER-BUFFER       0
	     ED-INTERACTIVE-P      NIL
	     ED-SEARCH-RING        NIL
	     ED-KILL-RING          NIL 
	     ED-CURRENT-DEFAULT-FONT 0 
	     ED-DEFAULT-FILE-NAME  ""
	     ED-LAST-FILE-NAME-TYPED-IN ""

	     ED-INITIAL-MODE-LINE-LIST     '(ED-MODE-EDITOR-NAME ED-MODE-MODE
				     ED-MODE-BUFFER-NAME ":  " ED-DEFAULT-FILE-NAME
				     ED-MODE-DEFAULT-FONT)
	     ED-MODE-LINE-LIST     ED-INITIAL-MODE-LINE-LIST
	     ED-MODE-EDITOR-NAME   "EINE  "
	     ED-MODE-MODE          "(LISP)  "
	     ED-MODE-BUFFER-NAME   'ED-DISPLAY-BUFFER-NAME
	     ED-MODE-DEFAULT-FONT  NIL
	     ED-RANDOM-MODE-LIST   '(ED-RANDOM-MODE)
	     ED-RANDOM-MODE        NIL
	     ED-FILE-NAME-MODE-LIST '(ED-RANDOM-MODE "  Default: " ED-DEFAULT-FILE-NAME)
	     ED-BUFFER-MODE-LIST   '(ED-RANDOM-MODE "  Current buffer: " ED-MODE-BUFFER-NAME)
	     ED-MOUSE-MODE-LIST    '(ED-RANDOM-MODE "  (Use the mouse):")

	     ED-REDISPLAY-LOSES    T          ;Boy, does it ever.
	     ED-REDISPLAY-DEGREE   0
	     ED-REDISPLAY-DEGREE-THIS-LEVEL 0
	     ED-SPECIAL-SCREEN-P   NIL
	     ED-SEARCH-RING        NIL
	     ED-MARK-STAYS         NIL
	     ED-REGION-MARKING-MODE 'ED-MARK-UNDERLINE
	     ED-MOUSE-VISIBILITY   NIL
	     ED-WINDOW-HACKING-OK-P T 
	     ED-RESET-LIST 
	     '((ED-NUMERIC-ARG   . 1)
	       (ED-NUMERIC-ARG-P . NIL)
	       (ED-MARK-STAYS . NIL))

	     ED-BARFOLA-FLAG NIL ED-ZOWIE-FLAG NIL
	     ED-LAST-COMMAND-CHAR NIL 
	     ED-RPCNT 1 ED-CURRENT-COMMAND-TYPE NIL
	     ED-LAST-COMMAND-TYPE NIL ED-SEARCH-RING-MAX-LENGTH 3 
	     ED-KILL-RING-MAX-LENGTH 10 
	     ED-IBP-LIMIT-BP NIL ED-DBP-LIMIT-BP NIL 
	     ED-KEYBOARD-IO-UNRCHF NIL
       )
       (ED-COMMAND-RESET)
       (ED-INITIALIZE-TAB-BUFFERS)

;-- Set up all of the tables.
       (SETQ ED-CONTROL-X-DISPATCH-TABLE
	     (MAKE-ARRAY ED-RANDOM-AREA 'ART-Q-LIST '(4 220)))
       (ED-SETUP-DISPATCH-TABLE ED-CONTROL-X-DISPATCH-TABLE
				ED-INITIAL-CONTROL-X-DISPATCH-TABLE)

       (SETQ ED-COMMAND-DISPATCH-TABLE
	     (MAKE-ARRAY ED-RANDOM-AREA 'ART-Q-LIST '(4 220)))
       (ED-SETUP-DISPATCH-TABLE ED-COMMAND-DISPATCH-TABLE ED-INITIAL-COMMAND-DISPATCH-TABLE)

       (SETQ ED-MOUSE-DISPATCH-TABLE
	     (ED-CONVERT-3D-LIST ED-INITIAL-MOUSE-DISPATCH-TABLE))

       (SETQ ED-LIST-SYNTAX-TABLE
	     (MAKE-ARRAY ED-RANDOM-AREA 'ART-4B 400))
       (ED-SETUP-TABLE ED-LIST-SYNTAX-TABLE ED-INITIAL-LIST-SYNTAX-LIST)

       (SETQ ED-WORD-SYNTAX-TABLE
	     (MAKE-ARRAY ED-RANDOM-AREA 'ART-1B 400))
       (ED-SETUP-TABLE ED-WORD-SYNTAX-TABLE ED-INITIAL-WORD-SYNTAX-LIST)
       (ED-INITIALIZE-SOME-MORE ARG ROOM))

; Very new screen format:
; V.4 Modified so that outline is part of window.  Numbers all off by 2.
;     Doc not yet modified, non-debug not hackedeither.  Only changed CODE for
;     DEBUG mode.
;  PC-PPR	   DEBUG MODE		  NON-DEBUG MODE
;Main window	002. - 302. (25)	002. - 386. (32)
;Top Half	002. - 146. (12)	002. - 182. (15)
;Bottom Half	151. - 295. (12)	187. - 367. (15)
;Status line	306. - 318. (1)		390. - 402. (1)
;Mini buffer	320. - 356. (3)		404. - 440. (3)
;Echo area	overlaps mini buffer	overlaps mini buffer
;Debug area	360. - 444. (7)		none
;Who line	444. - 454. (1)		444. - 454. (1)

(DEFUN ED-INITIALIZE-SOME-MORE (ARG ROOM &AUX MBNAME)
;-- Create pieces of paper and windows.

       (ED-INITIALIZE-MOUSE)
       (COND (ED-DEBUG-P
	      (SETQ ED-MAIN-WINDOW
		    (ED-CREATE-WINDOW 'ED-MAIN-WINDOW 000. 304.))    ;25. lines
	      (SETQ ED-TOP-HALF-WINDOW
		    (ED-CREATE-WINDOW 'ED-TOP-HALF 000. 148.))	     ;12. lines
	      (SETQ ED-BOTTOM-HALF-WINDOW
		    (ED-CREATE-WINDOW 'ED-BOTTOM-HALF 149. 297.))    ;12. lines
	      (SETQ ED-DISPLAY-PC-PPR
		    (TV-DEFINE-PC-PPR 'ED-DISPLAY-PC-PPR (LIST TVFONT) 'LEFT 2 'RIGHT 574.
				      'TOP 002. 'BOTTOM 302. 'MORE-P T
				      'ACTIVATE-P NIL))
	      (SETQ ED-STATUS-PC-PPR				     ;1 lines
		    (TV-DEFINE-PC-PPR 'ED-STATUS-PC-PPR (LIST TVFONT) 'LEFT 2 'RIGHT 574.
				      'BLINKER-P NIL 'TOP 306. 'BOTTOM 318. 'MORE-P NIL
				      'ACTIVATE-P NIL))
	      (SETQ ED-MINI-BUFFER-WINDOW
		    (ED-CREATE-WINDOW 'ED-MINI-BUFFER 318. 358.))    ;3 lines
	      (SETF (ED-WINDOW-BLIND ED-MINI-BUFFER-WINDOW) T)	     ;????
	      (SETQ ED-ECHO-PC-PPR
		    (TV-DEFINE-PC-PPR 'ED-ECHO-PC-PPR (LIST TVFONT)
				      'BLINKER-P NIL 'TOP 320. 'BOTTOM 356. 'MORE-P NIL
				      'LEFT 2 'RIGHT 574. 'ACTIVATE-P NIL))
	      (SETQ ED-ECHO-BLINKER
		    (TV-DEFINE-BLINKER ED-ECHO-PC-PPR 'FOLLOW-P T 'VISIBILITY 'BLINK))
	      (SETQ ED-DEBUG-PC-PPR				     ;7 lines
		    (TV-DEFINE-PC-PPR 'ED-DEBUG-PC-PPR (LIST TVFONT) 'BLINKER-P NIL
				      'TOP 360. 'BOTTOM 444. 'MORE-P NIL
				      'ACTIVATE-P NIL)))
	     (T
	      (SETQ ED-MAIN-WINDOW
		    (ED-CREATE-WINDOW 'ED-MAIN-WINDOW 002. 386.))    ;32. lines
	      (SETQ ED-TOP-HALF-WINDOW
		    (ED-CREATE-WINDOW 'ED-TOP-HALF 002. 182.))	     ;15. lines
	      (SETQ ED-BOTTOM-HALF-WINDOW
		    (ED-CREATE-WINDOW 'ED-BOTTOM-HALF 187. 367.))    ;15. lines

	      (SETQ ED-STATUS-PC-PPR				     ;1 lines
		    (TV-DEFINE-PC-PPR 'ED-STATUS-PC-PPR (LIST TVFONT) 'LEFT 2 'RIGHT 574.
				      'BLINKER-P NIL 'TOP 390. 'BOTTOM 402. 'MORE-P NIL
				      'ACTIVATE-P NIL))
	      (SETQ ED-DISPLAY-PC-PPR
		    (TV-DEFINE-PC-PPR 'ED-DISPLAY-PC-PPR (LIST TVFONT) 'LEFT 2 'RIGHT 574.
				      'TOP 002. 'BOTTOM 386. 'MORE-P T
				      'ACTIVATE-P NIL))
	      (SETQ ED-MINI-BUFFER-WINDOW
		    (ED-CREATE-WINDOW 'ED-MINI-BUFFER 404. 440.))    ;3 lines
	      (SETF (ED-WINDOW-BLIND ED-MINI-BUFFER-WINDOW) T)	     ;????
	      (SETQ ED-ECHO-PC-PPR
		    (TV-DEFINE-PC-PPR 'ED-ECHO-PC-PPR (LIST TVFONT)
				      'BLINKER-P NIL 'TOP 404. 'BOTTOM 440. 'MORE-P NIL
				      'LEFT 2 'RIGHT 574. 'ACTIVATE-P NIL))
	      (SETQ ED-ECHO-BLINKER
		    (TV-DEFINE-BLINKER ED-ECHO-PC-PPR 'FOLLOW-P T 'VISIBILITY 'BLINK))
	      (SETQ ED-DEBUG-PC-PPR ED-DISPLAY-PC-PPR)
	      ))
       (TV-DEACTIVATE-PC-PPR ED-ECHO-PC-PPR)
       (SETQ ED-WINDOW ED-MAIN-WINDOW
	     ED-WINDOWS-DISPLAYED (LIST ED-MAIN-WINDOW))

;-- Create streams.

       (COND (ED-DEBUG-P
	      (SETQ ED-DEBUG-STREAM (TV-MAKE-STREAM ED-DEBUG-PC-PPR)))
	     (T (SETQ ED-DEBUG-STREAM (FSYMEVAL 'CONSOLE-IO))))
       (SETQ ED-ECHO-STREAM (TV-MAKE-STREAM ED-ECHO-PC-PPR))
       (SETQ ED-STATUS-STREAM (TV-MAKE-STREAM ED-STATUS-PC-PPR))
       (SETQ ED-DISPLAY-STREAM (TV-MAKE-STREAM ED-DISPLAY-PC-PPR))

;-- Create mini-buffer.
       
       (SETQ MBNAME (INTERN "Mini buffer"))
       (SETQ ED-MINI-BUFFER (ED-CREATE-BUFFER MBNAME 3))	;3 IS RANDOM.
       (SETQ ED-BUFFER-ALIST
	     (DELQ (ASSQ MBNAME ED-BUFFER-ALIST) ED-BUFFER-ALIST))
       (ED-SELECT-BUFFER ED-MINI-BUFFER-WINDOW ED-MINI-BUFFER)
       (SETF (ED-BUFFER-PATHNAME ED-MINI-BUFFER)
	     (INTERN "This is the minibuffer's default file name!")) ;error check

;-- Try temp area hack.
       (ED-COM-ENTER-TEMP-AREA NIL)
       (SETQ ED-SPACES-STRING (MAKE-ARRAY NIL ART-STRING 120.))
       (DO I 0 (1+ I) (>= I 120.) (AS-1 40 ED-SPACES-STRING I))

;-- Print out storage statistics.

       (PRINT (- (AREA-FREE-POINTER DEFAULT-ARRAY-AREA) ROOM))
       (PRINC " words of storage used during initialization.")
       (TERPRI)
;THE TV IS 37. HIGH BY 95. WIDE = 45 BY 137

       (SETQ ED-HAS-BEEN-INITIALIZED-P T)
       )

(DEFUN ED-RECOVER NIL
    (ED-PRE-RECOVER)
    (ED-POST-RECOVER))

(DEFUN ED-PRE-RECOVER ()				;First thing called by ED-TOP-LEVEL.
   (SETQ TV-WHO-LINE-PROGRAM-NAME "")			;Be careful what gets put in here.
   (ED-RESET-STANDARD-STREAMS)
   (ED-RESET-MOUSE)
   (SETQ ED-KEYBOARD-IO-UNRCHF NIL)
   (SETQ ED-WINDOW-HACKING-OK-P T)
   (SETQ ED-MODE-LINE-LIST ED-INITIAL-MODE-LINE-LIST)
   )

(DEFUN ED-RESET-STANDARD-STREAMS ()
    (SETQ STANDARD-OUTPUT ED-SAVED-STANDARD-OUTPUT
	  STANDARD-INPUT ED-SAVED-STANDARD-INPUT
	  ERROR-OUTPUT ED-SAVED-ERROR-OUTPUT))

(DEFUN ED-POST-RECOVER ()
   (SETQ FILE-ERROR 'ERROR)
   (SETQ CONSOLE-IO-PC-PPR ED-CONSOLE-IO-PC-PPR-SAVED)
   (TV-ACTIVATE-PC-PPR CONSOLE-IO-PC-PPR)

   (SETQ ED-INTERACTIVE-P NIL)
   (DO L ED-WINDOWS-DISPLAYED (CDR L) (NULL L)
     (TV-SET-BLINKER-VISIBILITY (ED-WINDOW-POINT-BLINKER (CAR L)) NIL)
     (DO X (ED-WINDOW-OTHER-BLINKERS (CAR L)) (CDR X) (NULL X)
       (TV-SET-BLINKER-VISIBILITY (SECOND (CAR X)) NIL)))
   (TV-SET-BLINKER-VISIBILITY (ED-WINDOW-POINT-BLINKER ED-MINI-BUFFER-WINDOW) NIL)
   (TV-SET-BLINKER-VISIBILITY MOUSE-BLINKER NIL)
   (TV-DEACTIVATE-PC-PPR ED-STATUS-PC-PPR)
   (TV-DEACTIVATE-PC-PPR ED-ECHO-PC-PPR)
   (AND ED-DEBUG-P
	(TV-DEACTIVATE-PC-PPR ED-DEBUG-PC-PPR))

   )
