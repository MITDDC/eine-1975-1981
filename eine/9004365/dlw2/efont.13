;;; This file is part of EINE, the Lisp Machine editor.        -*-LISP-*-
;;; For more information see LISPM2;EINE INFO.

;; This file contains functions for hacking multiple fonts.

(SPECIAL ED-MAIN-WINDOW-WITH-FONTS)
(DECLARE (SETQ RETAIN-VARIABLE-NAMES-SWITCH 'ARGS))
(DECLARE (SETQ OPEN-CODE-MAP-SWITCH T))

;Basic primitive to change the font of characters in a region.
;Returns ED-DIS-BUFFER for tail recursive convenience.
(DEFUN ED-CHANGE-FONT-BETWEEN (BP1 BP2 FONT-NUM)
  (MULTIPLE-VALUE (BP1 BP2)
		  (ED-ORDER-BPS BP1 BP2))
  (DO ((I (ED-BP-LINE-NUM BP1) (1+ I))
       (IE (ED-BP-LINE-NUM BP2))
       (JS (ED-BP-CHAR-POS BP1) 0)
       (JE)
       (LINE)
       (CH))
      ((> I IE) ED-DIS-BUFFER)
    (SETQ LINE (AR-1 ED-OPEN-BUFFER I))
    (SETQ JE (COND ((= I IE) (ED-BP-CHAR-POS BP2)) (T (ED-LINE-FILL-POINTER LINE))))
    (ED-MUNG LINE)
    (OR (EQ (ARRAY-TYPE LINE) 'ART-16B)
	(SETQ LINE (ED-EXPAND-LINE LINE NIL 'ART-16B)))
    (DO J JS (1+ J) (>= J JE)
      (AS-1 (DPB FONT-NUM %%CH-FONT (AR-1 LINE J)) LINE J))))

;Input the font to be changed to, returns number.
;If USE-PREVIOUS-P is T, successive font change commands only ask for a font once.
;For the moment, allowed font names are letters from A through O.  This will change.
(DEFUN ED-INPUT-FONT-NAME (USE-PREVIOUS-P)
  (PROG (CH)
    (OR USE-PREVIOUS-P (GO INP))
    (SETQ ED-CURRENT-COMMAND-TYPE 'FONT-CHANGE)
    (AND (EQ ED-LAST-COMMAND-TYPE 'FONT-CHANGE)
	 (RETURN ED-SAVE-FONT-NUM))
INP (TV-SET-BLINKER-VISIBILITY ED-ECHO-BLINKER 'BLINK)
    (TV-CLEAR-PC-PPR ED-ECHO-PC-PPR)
    (TV-STRING-OUT ED-ECHO-PC-PPR "Font ID: ")
    (TV-SET-BLINKER-VISIBILITY ED-ECHO-BLINKER 'BLINK)
RCH (SETQ CH (FUNCALL ED-COMMAND-STREAM 'TYI))
    (AND (OR (= CH 507) (= CH 547)) (ED-BARF)) ;CONTROL-G
    (AND (> CH 140) (SETQ CH (- CH 40)))
    (OR (AND (>= CH 101) (<= CH 117))
	(PROG2 (TV-BEEP) (GO RCH)))
    (TV-TYO ED-ECHO-PC-PPR CH)
    (TV-SET-BLINKER-VISIBILITY ED-ECHO-BLINKER NIL)
    (SETQ ED-REDISPLAY-LOSES T)
    (RETURN (SETQ ED-SAVE-FONT-NUM (- CH 101)))))

(DEFUN ED-COM-CHANGE-FONT-CHAR (CHR)
  (ED-CHANGE-FONT-BETWEEN (ED-COPY-BP (ED-BUFFER-POINT) 'TEMP)
			  (OR (ED-MOVE-BP-FORWARD (ED-BUFFER-POINT) ED-NUMERIC-ARG) (ED-BARF))
			  (ED-INPUT-FONT-NAME T)))
  
(DEFUN ED-COM-CHANGE-FONT-WORD (CHR &AUX BP)
  (SETQ BP (ED-COPY-BP (ED-BUFFER-POINT) 'TEMP))
  (ED-MOVE-POINT (ED-FORWARD-WORD-BP (ED-BUFFER-POINT) ED-NUMERIC-ARG))
  (ED-CHANGE-FONT-BETWEEN BP
			  (ED-BUFFER-POINT)
			  (ED-INPUT-FONT-NAME T)))

(DEFUN ED-COM-CHANGE-FONT-REGION (CHR)
  (OR (ED-BUFFER-MARK-P) (ED-BARF))
  (SETQ ED-MARK-STAYS T)
  (ED-CHANGE-FONT-BETWEEN (ED-BUFFER-POINT) (ED-BUFFER-MARK) (ED-INPUT-FONT-NAME NIL)))

(DEFUN ED-COM-CHANGE-DEFAULT-FONT (CHR)
  (SETQ ED-CURRENT-DEFAULT-FONT (ED-INPUT-FONT-NAME NIL))
  (SETQ ED-MARK-STAYS T)
  ED-DIS-NONE)

;THIS IS A TEMPORARY KLUDGE TO ALLOW CREATION OF WINDOWS WITH RANDOM FONTS IN THEM.
(DEFUN ED-WITH-FONTS (VICTIM &REST FONTS ;FOR FONT IDS A,B,C,D,E,F,G,H,I,J,K,L,M,N,O
		       &AUX (ED-MODE-DEFAULT-FONT (FSYMEVAL 'ED-DISPLAY-CURRENT-FONT)))
  (OR (BOUNDP 'ED-RANDOM-AREA)
      (ED-INITIALIZE))
  ((LAMBDA (ED-MAIN-WINDOW ED-TOP-HALF-WINDOW ED-BOTTOM-HALF-WINDOW)
      (ED VICTIM))
   (ED-CREATE-WINDOW 'ED-MAIN-WINDOW-WITH-FONTS 0 300. 0 576. FONTS)
   (ED-CREATE-WINDOW 'ED-TOP-HALF-WINDOW-WITH-FONTS 0 148. 0 576. FONTS)
   (ED-CREATE-WINDOW 'ED-BOTTOM-HALF-WINDOW-WITH-FONTS 149. 297. 0. 576. FONTS)))

; This is a function suitable for being put on ED-MODE-LINE-LIST.
(DEFUN ED-DISPLAY-CURRENT-FONT ()
    (TV-STRING-OUT ED-STATUS-PC-PPR "Font: ")
    (TV-TYO ED-STATUS-PC-PPR (+ 101 ED-CURRENT-DEFAULT-FONT))
    (TV-STRING-OUT ED-STATUS-PC-PPR " "))

;Makes ED-WINDOW use a specified list of fonts.
;Each font can be specified as either an actual font-array or a symbol evaluating to one.
(DEFUN ED-REDEFINE-FONTS (FONT-LIST &AUX PC-PPR MAIN-FONT HEIGHT WIDTH)
       (SETQ PC-PPR (ED-WINDOW-PC-PPR ED-WINDOW))
       (TV-REDEFINE-PC-PPR PC-PPR
                   'FONTS (MAPCAR (FUNCTION (LAMBDA (FONT-OR-ATOM)
                                     (COND ((ATOM FONT-OR-ATOM) (SYMEVAL FONT-OR-ATOM))
                                           (T FONT-OR-ATOM))))
                                  FONT-LIST))
       (SETQ MAIN-FONT (AR-1 (PC-PPR-FONT-MAP PC-PPR) 0))
       (SETQ HEIGHT (FONT-BLINKER-HEIGHT MAIN-FONT)
             WIDTH (FONT-BLINKER-WIDTH MAIN-FONT))
       (SETF (ED-WINDOW-FILL-POINTER ED-WINDOW) 
             (// (- (PC-PPR-BOTTOM-MARGIN PC-PPR) (PC-PPR-TOP-MARGIN PC-PPR))
                 (PC-PPR-LINE-HEIGHT PC-PPR)))
       (MAPC (FUNCTION (LAMBDA (BLINKER)
                               (TV-SET-BLINKER-SIZE BLINKER HEIGHT WIDTH)))
             (PC-PPR-BLINKER-LIST PC-PPR))
       ED-DIS-SCREEN)

(DEFUN ED-COM-REDEFINE-FONTS (IGNORE)
    (ED-REDEFINE-FONTS
     (READ-FROM-STRING (ED-GET-STRING-FROM-MINI-BUFFER "(font1 font2 ...): ")))
    ED-DIS-SCREEN)
